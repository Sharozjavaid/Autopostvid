name: Deploy to GCP

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  VM_NAME: philosophy-bot-vm
  ZONE: us-central1-a
  IMAGE_NAME: philosophy-bot

jobs:
  deploy:
    name: Build and Deploy to GCP VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Create .env file on VM
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.ZONE }} --command="
            cat > ~/philosophy_video_generator/.env << 'EOF'
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}
          FAL_KEY=${{ secrets.FAL_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          TIKTOK_CLIENT_KEY=${{ secrets.TIKTOK_CLIENT_KEY }}
          TIKTOK_CLIENT_SECRET=${{ secrets.TIKTOK_CLIENT_SECRET }}
          EMAIL_SENDER=${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENT=${{ secrets.EMAIL_RECIPIENT }}
          EOF
          "

      - name: Stop existing container
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.ZONE }} --command="
            sudo docker stop philosophy-agent 2>/dev/null || true
            sudo docker rm philosophy-agent 2>/dev/null || true
          "

      - name: Copy project files to VM
        run: |
          gcloud compute scp --recurse --zone=${{ env.ZONE }} \
            --exclude='.git/*' \
            --exclude='__pycache__/*' \
            --exclude='*.pyc' \
            --exclude='.env' \
            . ${{ env.VM_NAME }}:~/philosophy_video_generator

      - name: Build and run new container
        run: |
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.ZONE }} --command="
            cd ~/philosophy_video_generator && \
            sudo docker build -t ${{ env.IMAGE_NAME }} . && \
            sudo docker run -d --name philosophy-agent \
              -p 8501:8501 \
              --env-file .env \
              --restart unless-stopped \
              ${{ env.IMAGE_NAME }}
          "

      - name: Verify deployment
        run: |
          echo "ðŸš€ Deployment complete!"
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.VM_NAME }} --zone=${{ env.ZONE }} --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "Dashboard URL: http://$EXTERNAL_IP:8501"
          
          # Wait for container to start
          sleep 10
          
          # Check if container is running
          gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.ZONE }} --command="
            sudo docker ps | grep philosophy-agent && echo 'âœ… Container is running' || echo 'âŒ Container not running'
          "

      - name: Post deployment summary
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.VM_NAME }} --zone=${{ env.ZONE }} --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Dashboard URL:** http://$EXTERNAL_IP:8501" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”‘ **Login:** Use your configured credentials" >> $GITHUB_STEP_SUMMARY
