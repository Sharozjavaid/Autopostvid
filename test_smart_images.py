#!/usr/bin/env python3
"""
Test the Smart Image Generator with Gemini Analysis
"""

from smart_image_generator import SmartImageGenerator
from gemini_handler import GeminiHandler
import json

def test_smart_image_generation():
    print("ğŸ§  Testing Smart Philosophy Image Generation")
    print("=" * 50)
    
    # Create test story data
    gemini = GeminiHandler()
    
    # Generate a story first
    print("ğŸ“– Generating Plato's Cave story...")
    story_data = gemini.generate_philosophy_story("Plato's Cave Allegory")
    
    if not story_data:
        print("âŒ Story generation failed")
        return
    
    print(f"âœ… Story generated: {len(story_data.get('script', ''))} characters")
    print(f"ğŸ¬ Hook: {story_data.get('hook', 'N/A')}")
    
    # Extract scenes
    scenes = story_data.get('scenes', [])
    print(f"ğŸ­ Scenes: {len(scenes)}")
    
    # Test smart image generation
    print("\nğŸ¨ Testing Smart Image Generation...")
    smart_gen = SmartImageGenerator()
    
    # Get intelligent analysis and prompts
    print("ğŸ§  Getting Gemini's intelligent analysis...")
    prompt_analysis = smart_gen.analyze_story_and_generate_image_prompts(story_data, scenes)
    
    print(f"\nğŸ“‹ GEMINI'S ANALYSIS:")
    print(f"Story Analysis: {prompt_analysis.get('story_analysis', 'N/A')}")
    print(f"Overall Aesthetic: {prompt_analysis.get('overall_aesthetic', 'N/A')}")
    
    # Show the intelligent prompts
    scene_prompts = prompt_analysis.get('scene_prompts', [])
    for i, prompt_info in enumerate(scene_prompts):
        print(f"\nğŸ¬ Scene {i+1}: {prompt_info.get('philosophical_concept', 'N/A')}")
        print(f"ğŸ­ Mood: {prompt_info.get('mood', 'N/A')}")
        print(f"ğŸ¨ Color Palette: {prompt_info.get('color_palette', 'N/A')}")
        print(f"ğŸ–¼ï¸  IMAGE PROMPT:")
        print(f"   {prompt_info.get('image_prompt', 'N/A')}")
        print(f"ğŸ’­ Visual Metaphor: {prompt_info.get('visual_metaphor', 'N/A')}")
    
    # Generate actual images with these intelligent prompts
    print(f"\nğŸ–¼ï¸  Generating images with intelligent prompts...")
    image_paths = smart_gen.generate_all_images(story_data, scenes)
    
    print(f"\nâœ… RESULTS:")
    print(f"ğŸ“ Generated {len(image_paths)} images:")
    for path in image_paths:
        print(f"   - {path}")
    
    print(f"\nğŸ¯ The prompts sent to image generation are now:")
    print(f"   âœ… Contextually aware of the full story")
    print(f"   âœ… Tailored to each scene's philosophical concept") 
    print(f"   âœ… Optimized for classical/cinematic aesthetic")
    print(f"   âœ… Generated by Gemini's deep understanding")
    
    return {
        "story": story_data,
        "analysis": prompt_analysis,
        "images": image_paths
    }

if __name__ == "__main__":
    result = test_smart_image_generation()
    
    if result:
        print(f"\nğŸ‰ Smart image generation test complete!")
        print(f"ğŸ”§ Next: Replace the placeholder generation with actual Nano API calls")
        print(f"ğŸ’¡ The prompts are now much more sophisticated and context-aware")