# Philosophy Video Generator - Cursor Rules

## Project Overview
This is a full-stack application for generating AI-powered philosophy-themed slideshows and videos.
- **Backend**: FastAPI + SQLAlchemy + SQLite (Python 3.11+)
- **Frontend**: React + TypeScript + Vite + TanStack Query
- **AI Services**: OpenAI GPT-4, Gemini, ElevenLabs, fal.ai

## Sub-Agent Patterns (Context Switching)

When working on specific areas, apply these specialized knowledge patterns:

### ğŸ—„ï¸ Database Agent
**Trigger**: Any work involving database, models, migrations, SQLAlchemy, or schema changes.

**Quick Reference** (see `docs/database.md` for full details):
1. Database file: `./philosophy_generator.db` (relative to working directory - run from project root!)
2. SQLite doesn't support all ALTER TABLE operations - see `docs/database.md` for migration patterns
3. Never use `metadata` as a column name (reserved by SQLAlchemy)
4. Always check schema with `PRAGMA table_info(tablename)` before/after changes
5. When adding columns, update BOTH the SQLAlchemy model AND run ALTER TABLE on existing databases
6. Models auto-create tables but DON'T auto-add columns to existing tables

**Checklist for Schema Changes**:
- [ ] Update SQLAlchemy model in `backend/app/models/`
- [ ] Run `ALTER TABLE` on local dev database
- [ ] Verify with `PRAGMA table_info()`
- [ ] Restart backend to pick up model changes
- [ ] Update `docs/database.md` schema section

**For complete details**: See `docs/database.md` (schema, migrations, operations, model files)

### ğŸ¤– Agent System Agent
**Trigger**: Work on the AI agent, tools, memory, or Claude integration.

**Quick Reference** (see `docs/agent.md` for full details):
1. Model config is in ONE place: `backend/app/config.py` â†’ `CLAUDE_MODEL`
2. Agent tools are in `backend/app/services/agent_tools.py`
3. System prompt is in `backend/app/services/agent_service.py`
4. Memory files are in `/memory/` - agent has tools to read/write them
5. Agent uses streaming SSE for responses

**For complete details**: See `docs/agent.md` (Claude config, memory system, gallery, streaming protocol)

### ğŸ“± TikTok Integration Agent
**Trigger**: Work on TikTok posting, OAuth, or social media features.

**Quick Reference** (see `docs/tiktok.md` for full details):
1. ALL uploads go to DRAFTS (never direct publish)
2. Videos use `/v2/post/publish/inbox/video/init/`
3. Photo slideshows use `/v2/post/publish/content/init/` with `post_mode: "MEDIA_UPLOAD"`
4. Images MUST be JPEG (not PNG) for photo posts
5. Tokens stored in `.tiktok_tokens.json`
6. Local testing won't work - TikTok needs public URLs

**For complete details**: See `docs/tiktok.md` (API endpoints, OAuth flow, CLI commands, troubleshooting)

### ğŸ“¸ Instagram Integration Agent (Post Bridge)
**Trigger**: Work on Instagram posting or Post Bridge API.

**Quick Reference** (see `docs/instagram.md` for full details):
1. Uses **Post Bridge API** (https://post-bridge.com) - no OAuth complexity
2. API Key: `pb_live_RP1nqdE71wi7Fki6iVziL1`
3. Instagram account: `philosophizeme_app` (ID: 41667)
4. Posts go DIRECTLY to Instagram (not drafts like TikTok)
5. Service: `backend/app/services/instagram_poster.py`
6. CLI: `instagram_cli.py` for testing
7. Max 10 images per carousel, PNG format supported

**For complete details**: See `docs/instagram.md` (API flow, CLI commands, agent tools)

### ğŸ¨ Image Generation Agent
**Trigger**: Work on image generation, fonts, themes, or text overlay.

**Quick Reference** (see `docs/fonts.md` for full font system):
1. Two-layer system: AI background + Pillow text overlay
2. Fonts are in `/fonts/` directory
3. Font config is in BOTH `text_overlay.py` files (root + backend)
4. Theme prompts are in `theme_config.py`
5. Always generate background first, then apply text
6. **Images are uploaded to GCS** - see Cloud Storage section

**For complete details**: See `docs/fonts.md` (font architecture, available fonts, rendering details, API endpoints)

### â˜ï¸ Cloud Storage Agent
**Trigger**: Work on file storage, image persistence, video storage, or cloud infrastructure.

**Quick Reference**:
1. **ALL generated content** uploads to **Google Cloud Storage** bucket: `philosophy-content-storage`
2. Public URLs: `https://storage.googleapis.com/philosophy-content-storage/...`
3. Service: `backend/app/services/cloud_storage.py`
4. Credentials file: `gcs-credentials.json` (gitignored)
5. Database stores GCS URLs instead of local paths
6. Frontend `getSlideImageUrl()` handles both GCS and local URLs automatically
7. Videos auto-upload via `upload_video_to_gcs()` helper

**GCS Bucket Structure:**
```
gs://philosophy-content-storage/
â”œâ”€â”€ videos/       # Generated MP4 videos (auto-uploaded after creation)
â”œâ”€â”€ slides/       # Final slides with text overlay
â”œâ”€â”€ images/       # AI-generated background images  
â”œâ”€â”€ tiktok/       # TikTok-specific content
â””â”€â”€ test/         # Test uploads
```

**Storage Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         VM (Temporary/Processing)        â”‚
â”‚                                          â”‚
â”‚  ğŸ Python code executes here            â”‚
â”‚  ğŸ—„ï¸ SQLite database (project metadata)  â”‚
â”‚  ğŸ“ Temp files during generation         â”‚
â”‚  ğŸ“ Logs (/logs/backend.log)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Auto-upload after generation
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Google Cloud Storage (Permanent)      â”‚
â”‚    gs://philosophy-content-storage       â”‚
â”‚                                          â”‚
â”‚  ğŸ“¹ videos/   - All generated videos     â”‚
â”‚  ğŸ–¼ï¸ slides/   - Final slide images       â”‚
â”‚  ğŸ¨ images/   - Background images        â”‚
â”‚  ğŸ“± tiktok/   - TikTok media             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Public URLs served globally
                    â–¼
    https://storage.googleapis.com/philosophy-content-storage/...
```

**Key Files:**
- `backend/app/services/cloud_storage.py` - Main GCS service
- `upload_video_to_gcs()` - Helper for video uploads
- `get_storage_service()` - Singleton accessor

**Upload Flow:**
1. Content generated on VM (video, image, etc.)
2. Saved to local temp directory
3. Auto-uploaded to GCS bucket
4. GCS public URL stored in database
5. Local file can be deleted (saves VM space)

### ğŸš€ DevOps Agent
**Trigger**: Work on deployment, GCP VM, nginx, server issues, 502 errors, or production debugging.

**Quick Reference** (see `docs/devops.md` for complete architecture):
1. **Full docs**: See `DEVOPS.md` AND `docs/devops.md` for complete architecture
2. **GCP VM**: `philosophy-bot-vm` in zone `us-central1-a`, IP `23.251.149.244`
3. **GCP Project**: `philosophy-bot-05854` (VM project, separate from AI API project)
4. **Code path on VM**: `/home/runner/philosophy_video_generator`
5. **Backend**: Uvicorn on port 8001, proxied by Nginx
6. **No git on VM**: Code synced via `gcloud compute scp`, not git pull

**What Lives Where:**
| Component | Location | Notes |
|-----------|----------|-------|
| Python code | VM | Runs the backend |
| SQLite database | VM | `/backend/philosophy_generator.db` |
| Logs | VM | `/logs/backend.log` |
| Videos, Images, Slides | **Cloud Storage** | Permanent, public URLs |

**Common Commands:**
```bash
# SSH to VM
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a

# Check if backend running
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a --command="ps aux | grep uvicorn"

# Copy file to VM
gcloud compute scp localfile.py philosophy-bot-vm:/tmp/ --zone=us-central1-a

# Restart backend (see docs/devops.md for full command)
```

**For complete details**: See `docs/devops.md` (VM access, deployment, CI/CD, troubleshooting)

### ğŸ” Security Agent
**Trigger**: Work on authentication, API security, rate limiting, or CORS.

**Quick Reference** (see `docs/security.md` for full details):
1. **API Key Required**: All protected endpoints require `X-API-Key` header
2. **Current API Key**: `b4TZ2d11ZDkXpDNU_V8m4KxyYdCdJMERKMyVvgyyYz0`
3. **Config**: `backend/app/config.py` â†’ `api_key` setting
4. **Middleware**: `backend/app/middleware/` contains auth, rate limiter, error handler
5. **Public endpoints**: `/`, `/api/health`, `/api/settings/models`, `/api/tiktok/media/*`
6. **SSE exception**: Agent streaming uses `?api_key=` query param (EventSource limitation)

**For complete details**: See `docs/security.md` (auth flow, rate limits, CORS, error handling, deployment)

## Directory Structure
```
/backend/app/          # FastAPI application
  /models/             # SQLAlchemy models (Project, Slide, SlideVersion, Automation, GalleryItem)
  /routers/            # API endpoints (projects, slides, images, scripts, automations, gallery, agent)
  /services/           # Business logic (image generation, text overlay, voice, agent_service)
  /schemas/            # Pydantic schemas
  /websocket/          # WebSocket for progress updates
/frontend/src/         # React application
  /api/client.ts       # API client with all endpoints (including gallery)
  /components/         # Reusable components (SlideEditor, GlassCard, AgentSlidePreview, GalleryPanel)
  /context/            # React contexts (AuthContext, GalleryContext)
  /pages/              # Page components (Agent, StaticSlideshow, Projects, etc.)
/fonts/                # Custom fonts for text overlay
/logs/                 # Runtime logs (gitignored)
/docs/                 # Detailed documentation (database, devops, integrations, etc.)
```

## Running the Project
```bash
./dev.sh      # Development mode (recommended) - runs frontend + backend with colored logs
./start.sh    # Background mode - services run after terminal closes
./stop.sh     # Stop all services
./logs.sh     # View logs (--backend, --frontend, --errors options)
```

## Key Conventions

### Backend (Python/FastAPI)
- All models use UUID strings as primary keys
- Use SQLAlchemy ORM with relationship definitions
- Routers follow REST conventions: GET/POST/PUT/DELETE
- Always create SlideVersion when modifying slide images or content
- Image generation always creates: background â†’ text overlay â†’ final image
- Use `slide.create_version(db, change_type, description)` for versioning
- **All protected routes require `X-API-Key` header** - see `docs/security.md`
- New routes default to protected; use `dependencies=[Depends(verify_api_key)]`
- Public routes (health, models) have NO auth dependency

### Frontend (React/TypeScript)
- Use TanStack Query for all API calls with proper queryKey patterns
- Use `getSlideImageUrl(path, cacheBuster?)` for all image URLs (production-ready)
- Never hardcode `http://127.0.0.1:8001` - use `API_BASE_URL` from client.ts
- Components use inline styles with motion from framer-motion
- GlassCard is the standard card component with `padding` and `gradient` props
- **API key is auto-included** via axios interceptor in `client.ts`
- Set `VITE_API_KEY` in `.env.local` (local) or Vercel (production)

### API Client Pattern
```typescript
// Always import helpers from client.ts
import { getSlideImageUrl, API_BASE_URL, reapplyTextOverlay } from '../api/client';

// Image URLs must use the helper for production compatibility
<img src={getSlideImageUrl(slide.final_image_path, cacheBuster) || ''} />
```

### Slide Versioning System
- Every image change creates a version in `slide_versions` table
- Change types: 'initial', 'text_edit', 'font_change', 'theme_change', 'regenerate', 'revert'
- Font changes use `/api/images/{id}/reapply-text` (fast, reuses background)
- Theme changes require full regeneration (new background needed)
- Versions can be retrieved with `/api/images/{id}/versions`
- Revert with `/api/images/{id}/revert/{version_number}`

### Image Generation Flow
1. Generate background image (AI) â†’ saved to `background_image_path`
2. Apply text overlay (Pillow) â†’ saved to `final_image_path`
3. Create SlideVersion with font/theme used
4. Update slide.current_font, current_theme, current_version

### Theme System
Available themes: `glitch_titans`, `oil_contrast`, `golden_dust`, `scene_portrait`
Each theme defines: base_prompt, hook_prompt, content_prompt, outro_prompt, negative_prompt

## Common Tasks

### Adding a New API Endpoint
1. Add route in `/backend/app/routers/<router>.py`
2. Add Pydantic schema in `/backend/app/schemas/` if needed
3. Add client function in `/frontend/src/api/client.ts`
4. Use in component with useMutation or useQuery

### Adding a New Slide Field
1. Add column to `/backend/app/models/slide.py`
2. Add to SlideVersion model if it should be versioned
3. Update Slide interface in `/frontend/src/api/client.ts`
4. Backend will auto-migrate on restart (SQLite)

### Debugging Image Issues
1. Check `logs/backend.log` for generation errors
2. Verify `background_image_path` exists on filesystem
3. Check browser console for image URL issues
4. Use `./logs.sh --errors` to find all errors

## Environment Variables

### Backend (.env in root)
```
OPENAI_API_KEY=sk-...
GOOGLE_API_KEY=...
ELEVENLABS_API_KEY=...
FAL_KEY=...
ANTHROPIC_API_KEY=...
API_KEY=your-secure-api-key-here  # Required for API authentication
```

### Frontend (.env.local in /frontend)
```
VITE_API_URL=http://127.0.0.1:8001  # or https://api.cofndrly.com for production
VITE_API_KEY=your-secure-api-key-here  # Must match backend API_KEY
```

## Production Deployment

### Domain & Infrastructure Overview
| Service | URL/Location | Platform |
|---------|--------------|----------|
| **React Frontend** | `https://app.cofndrly.com` | Vercel |
| **Backend API** | `https://api.cofndrly.com` | GCP VM (`philosophy-bot-vm`) |
| **Videos** | `https://storage.googleapis.com/philosophy-content-storage/videos/...` | GCS Bucket |
| **Slides** | `https://storage.googleapis.com/philosophy-content-storage/slides/...` | GCS Bucket |
| **Images** | `https://storage.googleapis.com/philosophy-content-storage/images/...` | GCS Bucket |
| **TikTok Callback** | `https://api.cofndrly.com/api/tiktok/callback` | GCP VM |

### GCP Projects (Two Separate Projects!)
| Project Name | Project ID | Purpose |
|--------------|------------|---------|
| **Philosophy Video Bot** | `philosophy-bot-05854` | VM, Cloud Storage, main infrastructure |
| **phil automation** | `gen-lang-client-0911658567` | Gemini AI API access only |

### Storage Summary
- **Database**: SQLite on VM (`/home/runner/.../backend/philosophy_generator.db`)
- **All media files**: Google Cloud Storage bucket `philosophy-content-storage`
- **Logs**: On VM (`/home/runner/.../logs/backend.log`)

**For complete deployment details**: See `docs/devops.md`

## Testing Changes
1. Backend auto-reloads with `--reload` flag
2. Frontend uses Vite HMR for instant updates
3. Always test font changes (fast path) and theme changes (full regen) separately
4. Check version history UI after making changes

## Code Style
- Python: Follow PEP 8, use type hints
- TypeScript: Strict mode, prefer interfaces over types
- React: Functional components with hooks only
- CSS: Inline styles with motion animations preferred
