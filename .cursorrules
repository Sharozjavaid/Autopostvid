# Philosophy Video Generator - Cursor Rules

## Project Overview
This is a full-stack application for generating AI-powered philosophy-themed slideshows and videos.
- **Backend**: FastAPI + SQLAlchemy + SQLite (Python 3.11+)
- **Frontend**: React + TypeScript + Vite + TanStack Query
- **AI Services**: OpenAI GPT-4, Gemini, ElevenLabs, fal.ai

## Directory Structure
```
/backend/app/          # FastAPI application
  /models/             # SQLAlchemy models (Project, Slide, SlideVersion, Automation)
  /routers/            # API endpoints (projects, slides, images, scripts, automations)
  /services/           # Business logic (image generation, text overlay, voice)
  /schemas/            # Pydantic schemas
  /websocket/          # WebSocket for progress updates
/frontend/src/         # React application
  /api/client.ts       # API client with all endpoints
  /components/         # Reusable components (SlideEditor, GlassCard, Button)
  /pages/              # Page components (StaticSlideshow, Projects, etc.)
/fonts/                # Custom fonts for text overlay
/logs/                 # Runtime logs (gitignored)
```

## Running the Project
```bash
./dev.sh      # Development mode (recommended) - runs frontend + backend with colored logs
./start.sh    # Background mode - services run after terminal closes
./stop.sh     # Stop all services
./logs.sh     # View logs (--backend, --frontend, --errors options)
```

## Key Conventions

### Backend (Python/FastAPI)
- All models use UUID strings as primary keys
- Use SQLAlchemy ORM with relationship definitions
- Routers follow REST conventions: GET/POST/PUT/DELETE
- Always create SlideVersion when modifying slide images or content
- Image generation always creates: background → text overlay → final image
- Use `slide.create_version(db, change_type, description)` for versioning

### Frontend (React/TypeScript)
- Use TanStack Query for all API calls with proper queryKey patterns
- Use `getSlideImageUrl(path, cacheBuster?)` for all image URLs (production-ready)
- Never hardcode `http://127.0.0.1:8001` - use `API_BASE_URL` from client.ts
- Components use inline styles with motion from framer-motion
- GlassCard is the standard card component with `padding` and `gradient` props

### API Client Pattern
```typescript
// Always import helpers from client.ts
import { getSlideImageUrl, API_BASE_URL, reapplyTextOverlay } from '../api/client';

// Image URLs must use the helper for production compatibility
<img src={getSlideImageUrl(slide.final_image_path, cacheBuster) || ''} />
```

### Slide Versioning System
- Every image change creates a version in `slide_versions` table
- Change types: 'initial', 'text_edit', 'font_change', 'theme_change', 'regenerate', 'revert'
- Font changes use `/api/images/{id}/reapply-text` (fast, reuses background)
- Theme changes require full regeneration (new background needed)
- Versions can be retrieved with `/api/images/{id}/versions`
- Revert with `/api/images/{id}/revert/{version_number}`

### Image Generation Flow
1. Generate background image (AI) → saved to `background_image_path`
2. Apply text overlay (Pillow) → saved to `final_image_path`
3. Create SlideVersion with font/theme used
4. Update slide.current_font, current_theme, current_version

### Theme System
Available themes: `glitch_titans`, `oil_contrast`, `golden_dust`, `scene_portrait`
Each theme defines: base_prompt, hook_prompt, content_prompt, outro_prompt, negative_prompt

### Font System - Complete Architecture

#### How Fonts Work in the Slideshow Pipeline

The slideshow generation uses a **two-layer compositing system**:

```
┌─────────────────────────────────────────────────────────────┐
│  LAYER 1: Background Image (AI-Generated)                   │
│  - Generated by GPT-Image-1.5, Flux, or DALL-E 3            │
│  - Contains NO text - pure visual/artistic background       │
│  - Saved to: slide.background_image_path                    │
│  - Dimensions: 1080x1920 (TikTok 9:16 vertical)             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  LAYER 2: Text Overlay (Pillow/PIL)                         │
│  - Rendered programmatically using TextOverlay class        │
│  - Uses TTF font files from /fonts/ directory               │
│  - Applies: shadow, outline, positioning, word wrap         │
│  - Composited onto background → saved to final_image_path   │
└─────────────────────────────────────────────────────────────┘
```

**Why this separation matters:**
- Font changes are FAST (reuses existing background, just re-renders text)
- Theme changes require full regeneration (new AI background needed)
- Text is always crisp (not AI-generated, so no artifacts)
- Consistent typography across all slides

#### Available Fonts

| Font ID | Name | Style | Best For |
|---------|------|-------|----------|
| `tiktok` | TikTok Sans | Official TikTok font, clean modern | Authentic TikTok look |
| `tiktok-bold` | TikTok Sans Bold | Official TikTok display | Bold headlines |
| `social` | Social Media (Default) | Montserrat Bold, sentence case | General social media |
| `bebas` | Bebas Neue | ALL CAPS display | Impact/punch |
| `montserrat` | Montserrat Bold | Modern sans-serif | Clean modern look |
| `cinzel` | Cinzel Bold | Roman/classical | Ancient wisdom vibes |
| `oswald` | Oswald Bold | Condensed sans | Strong headlines |
| `cormorant` | Cormorant Italic | Elegant serif italic | @philosophaire style |

#### Font Files Location

```
/fonts/                          # Project root fonts directory
  ├── TikTokSans-Regular.ttf     # Official TikTok font
  ├── TikTokSans-Bold.ttf        # Official TikTok bold
  ├── Montserrat-Bold.ttf        # Default for "social" style
  ├── Montserrat-Italic.ttf
  ├── Bebas-Regular.ttf          # All-caps display
  ├── Cinzel-Bold.ttf            # Classical/Roman
  ├── Oswald-Bold.ttf            # Condensed headlines
  └── CormorantGaramond-Italic.ttf  # Elegant italic
```

#### Font Configuration in Code

Each font has settings that control rendering behavior:

```python
# In text_overlay.py - FONTS dict
"tiktok": {
    "name": "TikTok Sans",
    "file": "TikTokSans-Regular.ttf",
    "category": "tiktok",
    "settings": {
        "uppercase": False,      # Sentence case (True = ALL CAPS)
        "shadow": True,          # Drop shadow for legibility
        "outline": True,         # Thin outline for contrast
        "outline_width": 2,      # Outline thickness in pixels
    }
}
```

#### API Endpoints for Fonts

```bash
# Get available fonts (frontend uses this for dropdowns)
GET /api/settings/models
# Returns: { fonts: [{ id, name, style }], ... }

# Generate image with specific font
POST /api/images/{slide_id}/generate
Body: { model: "gpt15", font: "tiktok", theme: "golden_dust" }

# Change font only (fast - reuses background)
POST /api/images/{slide_id}/reapply-text?font=tiktok-bold

# Full regenerate with new theme + font
POST /api/images/{slide_id}/generate
Body: { model: "gpt15", font: "bebas", theme: "oil_contrast" }
```

#### Adding a New Font

1. **Add TTF file** to `/fonts/` directory
2. **Update both text_overlay.py files:**
   - `/text_overlay.py` (root - for CLI/scripts)
   - `/backend/app/services/text_overlay.py` (for API)
3. **Add to FONTS dict:**
```python
"new-font": {
    "name": "Display Name",
    "description": "What it looks like",
    "file": "NewFont-Bold.ttf",
    "category": "modern",  # tiktok, social, modern, elegant, classical, display
    "settings": { ... }  # Optional overrides
}
```
4. **Add to FONT_CATEGORIES** if creating new category
5. **Update API response** in `/backend/app/main.py`:
```python
"fonts": [
    {"id": "new-font", "name": "Display Name", "style": "Description"},
    ...
]
```

#### Font Rendering Details (TextOverlay class)

The TextOverlay class handles all text rendering with these methods:

```python
# Simple text on image
overlay.add_text_to_image(image_path, text, output_path, font_name="tiktok")

# Full slide with title, subtitle, number
overlay.create_slide(
    background_path="bg.png",
    output_path="slide.png",
    title="MARCUS AURELIUS",
    subtitle="The Emperor-Philosopher",
    slide_number=1,
    font_name="tiktok-bold"
)

# Hook slide (first slide - grabs attention)
overlay.create_hook_slide(background_path, output_path, hook_text, font_name="tiktok")

# Outro slide (call to action)
overlay.create_outro_slide(background_path, output_path, text, subtitle, font_name="social")
```

#### Text Rendering Effects

1. **Shadow**: Drop shadow for depth (offset 3-4px, semi-transparent black)
2. **Outline**: Thin stroke around text for legibility on any background
3. **Social Style**: Combines shadow + thin outline (best for readability)

```python
# Social style rendering (used by tiktok, social fonts)
def _draw_text_social_style(draw, position, text, font):
    # 1. Draw drop shadow (offset bottom-right)
    # 2. Draw thin outline (2px black stroke)
    # 3. Draw white text on top
```

#### Important Notes

- **Backend runs from /backend/**: Font path is resolved as `Path(__file__).parent.parent.parent.parent / "fonts"`
- **Font caching**: TextOverlay caches loaded fonts by size for performance
- **Fallback fonts**: If custom font fails, falls back to system fonts (Helvetica, Arial)
- **TikTok dimensions**: All slides are 1080x1920 (9:16 vertical format)

## Common Tasks

### Adding a New API Endpoint
1. Add route in `/backend/app/routers/<router>.py`
2. Add Pydantic schema in `/backend/app/schemas/` if needed
3. Add client function in `/frontend/src/api/client.ts`
4. Use in component with useMutation or useQuery

### Adding a New Slide Field
1. Add column to `/backend/app/models/slide.py`
2. Add to SlideVersion model if it should be versioned
3. Update Slide interface in `/frontend/src/api/client.ts`
4. Backend will auto-migrate on restart (SQLite)

### Debugging Image Issues
1. Check `logs/backend.log` for generation errors
2. Verify `background_image_path` exists on filesystem
3. Check browser console for image URL issues
4. Use `./logs.sh --errors` to find all errors

## Environment Variables

### Backend (.env in root)
```
OPENAI_API_KEY=sk-...
GOOGLE_API_KEY=...
ELEVENLABS_API_KEY=...
FAL_KEY=...
```

### Frontend (.env in /frontend)
```
VITE_API_URL=http://127.0.0.1:8001  # or production URL
```

## Database
- SQLite database at `/backend/philosophy_generator.db`
- Models auto-create tables on startup
- Use Alembic for production migrations if needed

## Testing Changes
1. Backend auto-reloads with `--reload` flag
2. Frontend uses Vite HMR for instant updates
3. Always test font changes (fast path) and theme changes (full regen) separately
4. Check version history UI after making changes

## Production Deployment

### Domain & Infrastructure Overview
| Service | URL | Status |
|---------|-----|--------|
| **React Frontend** | `https://app.cofndrly.com` | ✅ Live on Vercel |
| **Backend API** | `https://api.cofndrly.com` | ✅ Live on GCP VM |
| **Static Images** | `https://api.cofndrly.com/static/images/...` | ✅ Served by FastAPI |
| **Static Slides** | `https://api.cofndrly.com/static/slides/...` | ✅ Served by FastAPI |
| **TikTok Callback** | `https://api.cofndrly.com/api/tiktok/callback` | ✅ Verified |

### GCP VM Details
- **VM Name**: `philosophy-bot-vm`
- **Zone**: `us-central1-a`
- **External IP**: `23.251.149.244`
- **Domain**: `api.cofndrly.com` → points to the VM (A record in GoDaddy)
- **Code Location on VM**: `/home/runner/philosophy_video_generator`

### Accessing the VM
```bash
# List VMs
gcloud compute instances list

# SSH into the VM
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a

# Run a command on the VM
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a --command="your-command-here"

# Check if backend is running
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a --command="ps aux | grep uvicorn"

# View backend logs
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a --command="cat /home/runner/philosophy_video_generator/logs/backend.log"
```

### SSL/HTTPS Setup (Already Configured)
- **Nginx** is installed as a reverse proxy on the VM
- **Let's Encrypt** SSL certificate via certbot (auto-renews)
- Config file: `/etc/nginx/sites-available/api.cofndrly.com`

Nginx proxies:
- `https://api.cofndrly.com` → `http://127.0.0.1:8001` (backend)

To check nginx status:
```bash
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a --command="sudo systemctl status nginx"
```

To reload nginx after config changes:
```bash
gcloud compute ssh philosophy-bot-vm --zone=us-central1-a --command="sudo nginx -t && sudo systemctl reload nginx"
```

### Static File Hosting
The FastAPI backend serves static files for TikTok API access:
- **Images**: Mounted at `/static/images/` → filesystem `generated_images/`
- **Slides**: Mounted at `/static/slides/` → filesystem `generated_slideshows/`

Example URLs:
```
https://api.cofndrly.com/static/images/King_Solomon_scene_1_nano.png
https://api.cofndrly.com/static/slides/gpt15/Stoicism_slide_0.png
```

### Firewall Rules
Ports 80 and 443 are open for HTTP/HTTPS traffic:
```bash
gcloud compute firewall-rules list --filter="name~http"
```

### TikTok Integration
- **Redirect URI**: `https://api.cofndrly.com/api/tiktok/callback`
- **Domain Verification**: ✅ `api.cofndrly.com` is verified in TikTok Developer Portal
- **Scopes**: `user.info.basic`, `video.upload`, `video.publish`
- Tokens stored in `.tiktok_tokens.json` (gitignored)

TikTok CLI commands:
```bash
# Start OAuth flow
python tiktok_cli.py auth

# Exchange code for tokens
python tiktok_cli.py token --code "YOUR_CODE"

# Upload video to drafts
python tiktok_cli.py upload --video "path/to/video.mp4" --title "Caption"

# Upload photo slideshow (uses native TikTok slideshow)
python tiktok_cli.py slideshow --images "img1.png,img2.png" --title "Caption"

# Check upload status
python tiktok_cli.py status --publish-id "PUBLISH_ID"

# View config and token status
python tiktok_cli.py info
```

### Frontend Deployment (Vercel)
The React frontend is deployed on Vercel at `https://app.cofndrly.com`.

**Vercel Project**: `frontend` under `sharozs-projects-b7468887`
**Environment Variable**: `VITE_API_URL=https://api.cofndrly.com`

Deploy commands:
```bash
cd frontend
npx vercel --prod      # Deploy to production
npx vercel env ls      # List environment variables
npx vercel logs        # View deployment logs
```

**DNS Setup Required** (GoDaddy):
Add an A record: `app.cofndrly.com` → `76.76.21.21` (Vercel's IP)

### Automation Scheduler
The backend includes APScheduler for running automations:

**How it works:**
1. Scheduler starts with the backend app
2. Loads all automations where `status="running"` and `is_active=True`
3. Creates cron jobs based on `schedule_times` and `schedule_days`
4. When triggered: generates slideshow → optionally posts to TikTok
5. Tracks run history in `automation_runs` table

**Key files:**
- `backend/app/services/scheduler.py` - APScheduler service
- `backend/app/services/tiktok_poster.py` - TikTok posting service
- `backend/app/models/automation_run.py` - Run history model

**API Endpoints:**
```bash
# Start/stop automation
POST /api/automations/{id}/start
POST /api/automations/{id}/stop

# Trigger immediate run (for testing)
POST /api/automations/{id}/run-now

# View run history
GET /api/automations/{id}/runs

# Get scheduler status
GET /api/automations/scheduler/status

# Configure TikTok posting
PUT /api/automations/{id}/tiktok-settings
```

**Enable TikTok auto-posting:**
Set `post_to_tiktok: true` in automation settings to automatically post slideshows.

### GitHub Actions Deployment
The project uses GitHub Actions for automated deployment. See `.github/workflows/deploy.yml`.

## Code Style
- Python: Follow PEP 8, use type hints
- TypeScript: Strict mode, prefer interfaces over types
- React: Functional components with hooks only
- CSS: Inline styles with motion animations preferred
