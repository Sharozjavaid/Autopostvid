# Font System - Complete Architecture

## How Fonts Work in the Slideshow Pipeline

The slideshow generation uses a **two-layer compositing system**:

```
┌─────────────────────────────────────────────────────────────┐
│  LAYER 1: Background Image (AI-Generated)                   │
│  - Generated by GPT-Image-1.5, Flux, or DALL-E 3            │
│  - Contains NO text - pure visual/artistic background       │
│  - Saved to: slide.background_image_path                    │
│  - Dimensions: 1080x1920 (TikTok 9:16 vertical)             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  LAYER 2: Text Overlay (Pillow/PIL)                         │
│  - Rendered programmatically using TextOverlay class        │
│  - Uses TTF font files from /fonts/ directory               │
│  - Applies: shadow, outline, positioning, word wrap         │
│  - Composited onto background → saved to final_image_path   │
└─────────────────────────────────────────────────────────────┘
```

**Why this separation matters:**
- Font changes are FAST (reuses existing background, just re-renders text)
- Theme changes require full regeneration (new AI background needed)
- Text is always crisp (not AI-generated, so no artifacts)
- Consistent typography across all slides

## Available Fonts

| Font ID | Name | Style | Best For |
|---------|------|-------|----------|
| `tiktok` | TikTok Sans | Official TikTok font, clean modern | Authentic TikTok look |
| `tiktok-bold` | TikTok Sans Bold | Official TikTok display | Bold headlines |
| `social` | Social Media (Default) | Montserrat Bold, sentence case | General social media |
| `bebas` | Bebas Neue | ALL CAPS display | Impact/punch |
| `montserrat` | Montserrat Bold | Modern sans-serif | Clean modern look |
| `cinzel` | Cinzel Bold | Roman/classical | Ancient wisdom vibes |
| `oswald` | Oswald Bold | Condensed sans | Strong headlines |
| `cormorant` | Cormorant Italic | Elegant serif italic | @philosophaire style |

## Font Files Location

```
/fonts/                          # Project root fonts directory
  ├── TikTokSans-Regular.ttf     # Official TikTok font
  ├── TikTokSans-Bold.ttf        # Official TikTok bold
  ├── Montserrat-Bold.ttf        # Default for "social" style
  ├── Montserrat-Italic.ttf
  ├── Bebas-Regular.ttf          # All-caps display
  ├── Cinzel-Bold.ttf            # Classical/Roman
  ├── Oswald-Bold.ttf            # Condensed headlines
  └── CormorantGaramond-Italic.ttf  # Elegant italic
```

## Font Configuration in Code

Each font has settings that control rendering behavior:

```python
# In text_overlay.py - FONTS dict
"tiktok": {
    "name": "TikTok Sans",
    "file": "TikTokSans-Regular.ttf",
    "category": "tiktok",
    "settings": {
        "uppercase": False,      # Sentence case (True = ALL CAPS)
        "shadow": True,          # Drop shadow for legibility
        "outline": True,         # Thin outline for contrast
        "outline_width": 2,      # Outline thickness in pixels
    }
}
```

## API Endpoints for Fonts

```bash
# Get available fonts (frontend uses this for dropdowns)
GET /api/settings/models
# Returns: { fonts: [{ id, name, style }], ... }

# Generate image with specific font
POST /api/images/{slide_id}/generate
Body: { model: "gpt15", font: "tiktok", theme: "golden_dust" }

# Change font only (fast - reuses background)
POST /api/images/{slide_id}/reapply-text?font=tiktok-bold

# Full regenerate with new theme + font
POST /api/images/{slide_id}/generate
Body: { model: "gpt15", font: "bebas", theme: "oil_contrast" }
```

## Adding a New Font

1. **Add TTF file** to `/fonts/` directory
2. **Update both text_overlay.py files:**
   - `/text_overlay.py` (root - for CLI/scripts)
   - `/backend/app/services/text_overlay.py` (for API)
3. **Add to FONTS dict:**
```python
"new-font": {
    "name": "Display Name",
    "description": "What it looks like",
    "file": "NewFont-Bold.ttf",
    "category": "modern",  # tiktok, social, modern, elegant, classical, display
    "settings": { ... }  # Optional overrides
}
```
4. **Add to FONT_CATEGORIES** if creating new category
5. **Update API response** in `/backend/app/main.py`:
```python
"fonts": [
    {"id": "new-font", "name": "Display Name", "style": "Description"},
    ...
]
```

## Font Rendering Details (TextOverlay class)

The TextOverlay class handles all text rendering with these methods:

```python
# Simple text on image
overlay.add_text_to_image(image_path, text, output_path, font_name="tiktok")

# Full slide with title, subtitle, number
overlay.create_slide(
    background_path="bg.png",
    output_path="slide.png",
    title="MARCUS AURELIUS",
    subtitle="The Emperor-Philosopher",
    slide_number=1,
    font_name="tiktok-bold"
)

# Hook slide (first slide - grabs attention)
overlay.create_hook_slide(background_path, output_path, hook_text, font_name="tiktok")

# Outro slide (call to action)
overlay.create_outro_slide(background_path, output_path, text, subtitle, font_name="social")
```

## Text Rendering Effects

1. **Shadow**: Drop shadow for depth (offset 3-4px, semi-transparent black)
2. **Outline**: Thin stroke around text for legibility on any background
3. **Social Style**: Combines shadow + thin outline (best for readability)

```python
# Social style rendering (used by tiktok, social fonts)
def _draw_text_social_style(draw, position, text, font):
    # 1. Draw drop shadow (offset bottom-right)
    # 2. Draw thin outline (2px black stroke)
    # 3. Draw white text on top
```

## Important Notes

- **Backend runs from /backend/**: Font path is resolved as `Path(__file__).parent.parent.parent.parent / "fonts"`
- **Font caching**: TextOverlay caches loaded fonts by size for performance
- **Fallback fonts**: If custom font fails, falls back to system fonts (Helvetica, Arial)
- **TikTok dimensions**: All slides are 1080x1920 (9:16 vertical format)
